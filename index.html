<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>HangerFlow</title>
    <style>
   :root {
  --bg: #0b0f14;
  --panel: #121821;
  --ink: #e8eef7;
  --muted: #9fb0c3;
  --accent: #3aa0ff;
  --accent-2: #7bd389;
  --danger: #ff6b6b;
  --border: #1e2633;
  --chip: #1a2431;
  --table-row: #0e141b;
  --table-row-alt: #121a23;
}

html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--ink);
  font: 14px/1.4 Inter, Segoe UI, Roboto, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  min-height: 100vh; /* ensures footer sticks to bottom */
}

main {
  flex: 1; /* pushes footer down when content is short */
}

/* Header base */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 10;
}


.left-nav { display: flex; gap: 8px; }
.brand {
  display: flex;
  align-items: center;
  justify-content: center;
}
.brand-logo {
  height: 45px;
  width: auto;
  filter: brightness(1.05) contrast(1.05);
}





.spacer { flex: 1; }

.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}
.header-logo img {
  height: 28px;
  width: auto;
  filter: brightness(0.95) contrast(1.05);
}

.nav-btn {
  background: transparent;
  color: var(--muted);
  border: none;
  padding: 6px 10px;
  font-size: 0.9rem;
  font-weight: 500;
  border-radius: 6px;
  cursor: pointer;
  transition: color 0.2s ease;
}
.nav-btn:hover {
  color: var(--ink);
}
.nav-btn.active {
  color: var(--accent);
  font-weight: 600;
  border-bottom: 2px solid var(--accent);
}



.header-logo img {
  height: 28px;
  width: auto;
  filter: brightness(0.95) contrast(1.05);
}

.page { display: none; padding: 16px; }
.page.active { display: block; }

.card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
}

/* Stock toolbar */
.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.search { position: relative; flex: 1; min-width: 240px; }
.search input {
  width: 100%;
  background: #0f1620;
  color: var(--ink);
  border: 1px solid var(--border);
  padding: 10px 12px;
  border-radius: 8px;
  outline: none;
}
.search input:focus { border-color: var(--accent); }

.chip {
  background: var(--chip);
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 8px 10px;
  border-radius: 999px;
  cursor: pointer;
  user-select: none;
}
.chip.active {
  color: #fff;
  border-color: var(--accent-2);
  box-shadow: 0 0 0 2px rgba(123,211,137,0.15) inset;
    background-color: #0078d4; /* your highlight color */
  color: #fff;
}


/* Table */
.table-wrap {
  overflow: auto;
  max-height: calc(100vh - 180px);
  border: 1px solid var(--border);
  border-radius: 10px;
}
table { width: 100%; border-collapse: separate; border-spacing: 0; }
thead th {
  position: sticky;
  top: 0;
  background: #0d141c;
  color: #cfe3ff;
  text-align: left;
  padding: 10px;
  font-size: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}
tbody td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody tr:nth-child(odd) { background: var(--table-row); }
tbody tr:nth-child(even) { background: var(--table-row-alt); }

.kpi {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
}
.kpi .pill {
  background: #0f1620;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
  color: var(--muted);
}
.pill strong { color: #fff; margin-left: 6px; }

.footerbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 6px;
  color: var(--muted);
}
.pager { display: flex; gap: 8px; align-items: center; }
.pager button {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #0f1620;
  color: var(--ink);
  cursor: pointer;
}
.sort-ind { margin-left: 6px; color: var(--muted); font-size: 12px; }
.muted { color: var(--muted); }

/* Page placeholders */
.placeholder {
  padding: 40px;
  text-align: center;
  color: var(--muted);
  border: 1px dashed var(--border);
  border-radius: 10px;
}

.upload-status { font-weight: bold; margin-top: 6px; color: var(--muted); }
.last-upload { font-size: 0.9em; color: var(--muted); }

/* Sticky footer styles */
.app-footer {
  background: var(--panel);
  border-top: 1px solid var(--border);
  padding: 8px 16px;
  font-size: 0.85rem;
  color: var(--muted);
}

/* Flex layout for content */
.footer-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px 12px;
}

/* Left/right spans */
.footer-content span {
  white-space: nowrap;
}

/* On narrow screens, stack neatly */
@media (max-width: 600px) {
  .footer-content {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
}


    </style>
<header class="app-header">
  <!-- Left navigation -->
  <div class="left-nav" id="leftNav">
    <button class="nav-btn active" data-route="stock">Stock</button>
    <button class="nav-btn" data-route="dispatch">Dispatched Orders</button>
    <button class="nav-btn" data-route="receiving">Receiving Stock</button>
    <button class="nav-btn" data-route="recycled">Recycled Stock</button>

  </div>

  <!-- Center: HangerFlow logo -->
  <div class="brand">
    <img src="https://drive.google.com/thumbnail?id=14aZ0hc9FRPCl_GI4ps1dtPnlyIarypaF&sz=w1000" 
         alt="HangerFlow Logo" class="brand-logo">
  </div>

  <div class="spacer"></div>

  <!-- Right: Premier Hangers logo + text -->
  <div class="header-logo">
    <img src="https://premierhangers.co.za/assets/images/image02.jpg?v=b8953020" 
         alt="Premier Hangers Pty Ltd">
  
  </div>
</header>


    <main>
     <!-- Stock Page -->
<section id="page-stock" class="page active">
  <div class="card">
    <div class="toolbar">
      <div id="colourChips" class="chips"></div>
      <div class="search">
        <input type="text" id="searchInput" placeholder="Search item, colour or PH code...">
      </div>
    </div>

    <div id="uploadStatus" class="upload-status">Waiting…</div>
    <div id="lastUpload" class="last-upload">Last update: –</div>

    <div class="kpi">
      <div class="pill">Items<strong id="stockTotalItems">0</strong></div>
      <div class="pill">Total QTY<strong id="stockTotalQty">0</strong></div>
      <div class="pill">Total Cartons<strong id="stockTotalCartons">0</strong></div>
    </div>

    <div class="table-wrap">
      <table id="stockTable">
        <thead><tr id="stockHeadRow"></tr></thead>
        <tbody id="stockBody"></tbody>
      </table>
    </div>

    <div class="footerbar">
      <div class="muted" id="rowInfo">0–0 of 0</div>
      <div class="pager">
        <button id="stockPrevBtn">Prev</button>
        <span class="muted" id="stockPagerLabel">1 / 1</span>
        <button id="stockNextBtn">Next</button>
        <select id="stockPerPageSelect" title="Rows per page">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
          <option>200</option>
        </select>
      </div>
    </div>
  </div>
</section>

      <!-- Dispatch Page -->
      <section id="page-dispatch" class="page">
        <div class="card">
          <div class="toolbar">
            <div id="dispatchChips" class="chips"></div>
            <div class="search">
              <input type="text" id="dispatchSearch" placeholder="Search Order Number, Colour, or Status…">
            </div>
          </div>

          <div class="kpi">
            <div class="pill">Orders<strong id="dispatchCount">0</strong></div>
            <div class="pill">Total Qty<strong id="dispatchQty">0</strong></div>
            <div class="pill">Total Cartons<strong id="dispatchCartons">0</strong></div>
          </div>

          <div class="table-wrap">
            <table id="dispatchTable">
              <thead><tr id="dispatchHeadRow"></tr></thead>
              <tbody id="dispatchBody"></tbody>
            </table>
          </div>

          <div class="footerbar">
            <div class="muted" id="dispatchRowInfo">0–0 of 0</div>
            <div class="pager">
              <button id="dispatchPrev">Prev</button>
              <span class="muted" id="dispatchPageNum">1</span>
              <button id="dispatchNext">Next</button>
              <select id="dispatchPageSize">
                <option>25</option><option selected>50</option><option>100</option><option>200</option>
              </select>
            </div>
          </div>
        </div>
      </section>


      <!-- Receiving Page -->
<section id="page-receiving" class="page">
  <div class="card">
    <div class="toolbar">
      <div id="receivingChips" class="chips"></div>
      <div class="search">
        <input type="text" id="receivingSearch" placeholder="Search Order Number, Colour, or Status…">
      </div>
    </div>

    <div class="kpi">
      <div class="pill">Orders<strong id="receivingCount">0</strong></div>
      <div class="pill">Total Qty<strong id="receivingQty">0</strong></div>
      <div class="pill">Total Cartons<strong id="receivingCartons">0</strong></div>
    </div>

    <div class="table-wrap">
      <table id="receivingTable">
        <thead><tr id="receivingHeadRow"></tr></thead>
        <tbody id="receivingBody"></tbody>
      </table>
    </div>

    <div class="footerbar">
      <div class="muted" id="receivingRowInfo">0–0 of 0</div>
      <div class="pager">
        <button id="receivingPrev">Prev</button>
        <span class="muted" id="receivingPageNum">1</span>
        <button id="receivingNext">Next</button>
        <select id="receivingPageSize">
          <option>25</option><option selected>50</option><option>100</option><option>200</option>
        </select>
      </div>
    </div>
  </div>
</section>
      <!-- Recycled Stock Page -->
<!-- Recycled Stock Page -->
<section id="page-recycled" class="page">
  <div id="recycled-stock-page">
    <div id="recycled-stock-card">
      <div id="recycled-stock-toolbar">
        <h2 id="recycled-stock-title">♻️ Recycled Stock</h2>
      </div>

      <div id="recycled-stock-content">
        <div id="recycled-stock-icon">♻️</div>
        <h3 id="recycled-stock-heading">Coming Soon</h3>
        <p id="recycled-stock-text">This section will display recycled stock data once it’s ready to go live.</p>
        <small id="recycled-stock-note">Please check back after the next update.</small>
      </div>
    </div>
  </div>

  <style>
    /* Scoped only to this block via #recycled-stock-page */
    #recycled-stock-page { padding: 1rem; font-family: system-ui, sans-serif; }
    #recycled-stock-card {
      border-radius: 10px;
      background: linear-gradient(135deg, #f0f5f1 0%, #e3f2e6 100%);
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      overflow: hidden; max-width: 600px; margin: auto;
    }
    #recycled-stock-toolbar { background: #2f855a; color: #fff; padding: 1rem 1.5rem; }
    #recycled-stock-title { margin: 0; font-weight: 600; font-size: 1.25rem; }
    #recycled-stock-content { padding: 3rem 2rem; text-align: center; color: #2d3748; }
    #recycled-stock-icon { font-size: 3rem; margin-bottom: 1rem; animation: recycledStockSpinSlow 8s linear infinite; display: inline-block; }
    #recycled-stock-heading { font-size: 1.5rem; margin: 0 0 0.5rem; }
    #recycled-stock-text { margin: 0 0 0.75rem; color: #4a5568; }
    #recycled-stock-note { color: #718096; font-size: 0.85rem; }
    @keyframes recycledStockSpinSlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</section>



    </main>

    <script>


// Throttle rapid calls
window.debounce = window.debounce || function (fn, delay) {
  let t;
  return function (...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
};

// Upload status text
window.setUploadStatus = window.setUploadStatus || function (text) {
  const el = document.getElementById('uploadStatus');
  if (el) el.textContent = text ?? '';
};

// "Last updated" stamp
window.updateLastUpload = window.updateLastUpload || function (d) {
  const el = document.getElementById('lastUpload');
  if (!el) return;
  const ts = window.formatDate ? window.formatDate(d) : '';
  el.textContent = `Last update: ${ts || '–'}`;
};

// Consistent date formatting
window.formatDate = window.formatDate || function (d) {
  let dt = d instanceof Date ? d : new Date(d);
  if (!(dt instanceof Date) || isNaN(dt)) return '';
  return dt.toLocaleString('en-ZA', {
    year: 'numeric', month: 'short', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false
  });
};

// Filter/colour chip button
window.makeChip = window.makeChip || function (label, isActive, _value, onClick) {
  const chip = document.createElement('button');
  chip.type = 'button';
  chip.className = 'chip' + (isActive ? ' active' : '');
  chip.textContent = label;
  chip.addEventListener('click', onClick, { passive: true });
  return chip;
};

// Group flat dispatch rows by order number
window.groupByOrder = window.groupByOrder || function (rows) {
  const map = Object.create(null);
  (rows || []).forEach(r => {
    const key = String(r['Order Number'] ?? r.order ?? '').trim();
    if (!map[key]) map[key] = { order: key, rows: [] };
    map[key].rows.push(r);
  });
  return Object.values(map);
};

// Filter dispatch groups by search/colour
window.applyDispatchFilters = window.applyDispatchFilters || function (groups) {
  const search = (STATE.dispatch.filters.search || '').toLowerCase();
  const colour = STATE.dispatch.filters.colour || null;
  return (groups || []).filter(g => {
    const text = g.rows.map(r =>
      `${r['Order Number']} ${r['Item ID']} ${r['Colour']} ${r['Status']} ${r['User']}`
    ).join(' ').toLowerCase();
    const matchesSearch = !search || text.includes(search);
    const matchesColour = !colour || g.rows.some(r => 
      (r['Colour'] || '').toLowerCase() === String(colour).toLowerCase()
    );
    return matchesSearch && matchesColour;
  });
};

// Keep grouped orders together in pagination
window.paginateGroups = window.paginateGroups || function (groups, pageSize) {
  const pages = [];
  let current = { rows: [] };
  let count = 0;
  (groups || []).forEach(g => {
    const gSize = g.rows?.length || 1;
    if (count > 0 && count + gSize > pageSize) {
      pages.push(current);
      current = { rows: [] };
      count = 0;
    }
    current.rows.push(...g.rows);
    count += gSize;
  });
  if (current.rows.length) pages.push(current);
  return pages;
};

const API = {
  baseUrl: 'https://script.google.com/macros/s/AKfycbzCF7yUZiprbPZtqCIRj6cy5iXaFYxs2iR22fArEFkIRG8Xq38DHcpzIz232OiKOPrdwg/exec',
  resource: 'stock',
  useJsonpFallback: true
};

/***************
 * GLOBAL STATE
 ***************/
const STATE = {
  stock: {
    data: [], filtered: [],
    sortKey: 'Colour', sortDir: 'asc',
    page: 1, pageSize: 50, colourFilter: null,
    columns: ['timestamp','Colour','QTY Per Carton','Total Cartons','Total QTY','PH Code']
  },
  dispatch: {
    raw: [], groups: [], filteredGroups: [], pages: [],
    pageIndex: 0, pageSize: 50, filters: { search: '', colour: null }
  },
  receiving: {
  raw: [],              // unfiltered data
  filteredGroups: [],   // after search/colour filters
  pages: [],            // paginated groups
  pageIndex: 0,
  pageSize: 50,
  filters: {
    search: '',
    colour: null        // null = All
  }
}
};

/***************
 * INIT
 ***************/
document.addEventListener('DOMContentLoaded', () => {
  setupNav();
  setupStockUI();
  setupDispatchUI();
  loadStock();
  switchPage('stock');
});

/***************
 * NAVIGATION
 ***************/
function setupNav() {
  document.getElementById('leftNav').addEventListener('click', (e) => {
    const btn = e.target.closest('.nav-btn');
    if (!btn) return;
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    switchPage(btn.dataset.route);
  });
}
function switchPage(route) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${route}`)?.classList.add('active');
  if (route === 'stock') loadStock();
  if (route === 'dispatch') loadDispatch();
  if (route === 'receiving') loadReceiving();
}

/***************
 * STOCK
 ***************/
// ---------- STATE ----------
STATE.stock = {
  data: [],
  filtered: [],
  columns: ['timestamp','Colour','QTY Per Carton','Total Cartons','Total QTY','PH Code'],

  // filters/sort
  colourFilter: null,
  sortKey: 'PH Code',
  sortDir: 'asc',

  // paging
  page: 1,
  pageSize: 50,
  totalPages: 1
};

// ---------- HELPERS ----------
function numOrNaN(v) {
  if (v === null || v === undefined || v === '') return NaN;
  const n = Number(String(v).replace(/[^\d.-]/g, ''));
  return Number.isFinite(n) ? n : NaN;
}

// ---------- SETUP ----------
function setupStockUI() {
  const head = document.getElementById('stockHeadRow');
  head.innerHTML = '';
  STATE.stock.columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    th.addEventListener('click', () => toggleStockSort(col));
    head.appendChild(th);
  });

  // search
  const searchEl = document.getElementById('searchInput');
  if (searchEl) {
    searchEl.addEventListener('input', debounce(() => {
      STATE.stock.page = 1;
      computeStockDerived();
      renderStock();
    }, 120));
  }

  // pager controls
  const prevBtn = document.getElementById('stockPrevBtn');
  const nextBtn = document.getElementById('stockNextBtn');
  const sizeSel = document.getElementById('stockPerPageSelect');

  if (prevBtn) prevBtn.addEventListener('click', () => goToStockPage(STATE.stock.page - 1));
  if (nextBtn) nextBtn.addEventListener('click', () => goToStockPage(STATE.stock.page + 1));
  if (sizeSel) sizeSel.addEventListener('change', (e) => {
    const v = parseInt(e.target.value, 10);
    if (!Number.isNaN(v) && v > 0) {
      STATE.stock.pageSize = v;
      STATE.stock.page = 1;
      computeStockDerived();
      renderStock();
    }
  });
}

// ---------- DATA LOAD ----------
function loadStock() {
  setUploadStatus('Loading…');
  fetch(`${API.baseUrl}?dataset=stock`)
    .then(res => res.json())
    .then(payload => {
      STATE.stock.data = (payload.rows || []).map(r => ({
        timestamp: r.timestampIso || r.timestamp || '',
        Colour: r['Colour'],
        'QTY Per Carton': r['QTY Per Carton'],
        'Total Cartons': r['Total Cartons'],
        'Total QTY': r['Total QTY'],
        'PH Code': r['PH Code'],
        _searchKey: `${r['Colour'] || ''} ${r['PH Code'] || ''}`.toLowerCase()
      }));

      buildStockChips();
      computeStockDerived();
      renderStock();

      updateLastUpload(new Date());
      setUploadStatus('Loaded');
    })
    .catch(err => { console.error(err); setUploadStatus('Failed'); });
}

// ---------- CHIPS ----------
function buildStockChips() {
  const wrap = document.getElementById('colourChips');
  if (!wrap) return;
  wrap.innerHTML = '';

  const makeActiveChip = (label, value) => {
    const isActive = STATE.stock.colourFilter === value;
    const chip = makeChip(label, isActive, value, () => {
      STATE.stock.colourFilter = value;
      STATE.stock.page = 1;
      computeStockDerived();
      renderStock();
      buildStockChips(); // rebuild so .active is reapplied
    });
    if (isActive) chip.classList.add('active');
    return chip;
  };

  // "All"
  wrap.appendChild(makeActiveChip('All', null));

  // colours
  const colours = [...new Set(
    STATE.stock.data.map(r => (r.Colour || '').toLowerCase().trim())
  )].filter(Boolean).sort();

  colours.forEach(c => wrap.appendChild(makeActiveChip(c, c)));
}

// ---------- DERIVATION (filter + sort + pagination math) ----------
function computeStockDerived() {
  const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
  const cf = STATE.stock.colourFilter;

  let out = STATE.stock.data;

  // search
  if (q) out = out.filter(r => r._searchKey.includes(q));

  // colour filter (only when not null)
  if (cf !== null) {
    out = out.filter(r => (r.Colour || '').toLowerCase().trim() === cf);
  }

  // sort
  const key = STATE.stock.sortKey;
  const dir = STATE.stock.sortDir === 'asc' ? 1 : -1;

  const numericCols = new Set(['QTY Per Carton','Total Cartons','Total QTY']);
  const isDate = key === 'timestamp';
  const isNumeric = numericCols.has(key);

  out = out.slice().sort((a, b) => {
    const av = a[key];
    const bv = b[key];

    let cmp = 0;
    if (isDate) {
      const ad = av ? new Date(av).getTime() : 0;
      const bd = bv ? new Date(bv).getTime() : 0;
      cmp = ad - bd;
    } else if (isNumeric) {
      const an = numOrNaN(av);
      const bn = numOrNaN(bv);
      const as = Number.isNaN(an) ? -Infinity : an;
      const bs = Number.isNaN(bn) ? -Infinity : bn;
      cmp = as - bs;
    } else {
      cmp = String(av ?? '').localeCompare(String(bv ?? ''), undefined, { numeric: true, sensitivity: 'base' });
    }

    if (cmp === 0) {
      // stable tie-breakers to keep paging stable
      cmp = String(a['PH Code'] ?? '').localeCompare(String(b['PH Code'] ?? ''), undefined, { numeric: true, sensitivity: 'base' });
      if (cmp === 0) {
        cmp = String(a['Colour'] ?? '').localeCompare(String(b['Colour'] ?? ''), undefined, { numeric: true, sensitivity: 'base' });
        if (cmp === 0) {
          const ad = a.timestamp ? new Date(a.timestamp).getTime() : 0;
          const bd = b.timestamp ? new Date(b.timestamp).getTime() : 0;
          cmp = ad - bd;
        }
      }
    }

    return cmp * dir;
  });

  STATE.stock.filtered = out;

  // pagination math
  const len = out.length;
  const ps = STATE.stock.pageSize;
  const pages = Math.ceil(len / ps);
  STATE.stock.totalPages = pages || 0;

  // clamp page
  if (pages === 0) {
    STATE.stock.page = 0; // represent empty state clearly
  } else {
    if (STATE.stock.page < 1) STATE.stock.page = 1;
    if (STATE.stock.page > pages) STATE.stock.page = pages;
  }
}
// ---------- PAGER HELPER ----------
function updateStockPager() {
  const lbl  = document.getElementById('stockPagerLabel');
  const prev = document.getElementById('stockPrevBtn');
  const next = document.getElementById('stockNextBtn');
  const info = document.getElementById('rowInfo');

  const totalPages = STATE.stock.totalPages || 0;
  const current    = STATE.stock.page || 0;
  const pageSize   = STATE.stock.pageSize;
  const totalRows  = STATE.stock.filtered.length;

  if (lbl) lbl.textContent = `${current} / ${totalPages}`;
  if (prev) prev.disabled  = current <= 1;
  if (next) next.disabled  = current >= totalPages || totalPages === 0;

  if (info) {
    if (!totalRows) {
      info.textContent = '0–0 of 0';
    } else {
      const start = (current - 1) * pageSize + 1;
      const end   = Math.min(start + pageSize - 1, totalRows);
      info.textContent = `${start}–${end} of ${totalRows}`;
    }
  }
}
// ---------- RENDER ----------
function renderStock() {
  // table
  const body = document.getElementById('stockBody');
  if (!body) return;
  body.innerHTML = '';

  const ps = STATE.stock.pageSize;
  const p = STATE.stock.page;
  const start = p > 0 ? (p - 1) * ps : 0;
  const end = start + ps;

  const pageRows = (p === 0) ? [] : STATE.stock.filtered.slice(start, end);

  if (pageRows.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = STATE.stock.columns.length;
    td.textContent = 'No stock to display';
    tr.appendChild(td);
    body.appendChild(tr);
  } else {
    pageRows.forEach(r => {
      const tr = document.createElement('tr');
      STATE.stock.columns.forEach(col => {
        const td = document.createElement('td');
        if (col === 'timestamp' && r[col]) {
          // localize to SA time; safe even if unsupported
          td.textContent = new Date(r[col]).toLocaleString('en-ZA', { hour12: false, timeZone: 'Africa/Johannesburg' });
        } else {
          td.textContent = r[col] ?? '';
        }
        tr.appendChild(td);
      });
      tr.dataset.phCode = r['PH Code'] ?? '';
      tr.dataset.colour = (r['Colour'] ?? '').toLowerCase().trim();
      body.appendChild(tr);
    });
  }

  // pager + totals
  updateStockPager();
  updateStockTotals();
}

/**************
 * DISPATCHED
 ***************/

function setupDispatchUI() {
  document.getElementById('dispatchSearch').addEventListener('input', debounce(() => {
    STATE.dispatch.filters.search = document.getElementById('dispatchSearch').value.trim().toLowerCase();
    STATE.dispatch.pageIndex = 0; // reset to first page
    recomputeDispatch();
  }, 120));

  // pager controls
  document.getElementById('dispatchPrev').addEventListener('click', () => goDispatchPage(STATE.dispatch.pageIndex - 1));
  document.getElementById('dispatchNext').addEventListener('click', () => goDispatchPage(STATE.dispatch.pageIndex + 1));
  document.getElementById('dispatchPageSize').addEventListener('change', e => {
    const v = parseInt(e.target.value, 10);
    if (!Number.isNaN(v) && v > 0) {
      STATE.dispatch.pageSize = v;
      STATE.dispatch.pageIndex = 0;
      recomputeDispatch();
    }
  });
}

function loadDispatch() {
  fetch(`${API.baseUrl}?dataset=dispatch`)
    .then(res => res.json())
    .then(payload => {
      STATE.dispatch.raw = (payload.rows||[]).map(r => {
        const iso = r.timestampIso || r['Timestamp'] || '';
        const d = new Date(iso);
        return {
          ...r,
          // ✅ normalize numeric fields so totals/sorting are reliable
          'Qty Per Carton': parseFloat(String(r['Qty Per Carton'] ?? '').replace(/[^\d.-]/g,'')) || 0,
          'Total Cartons':  parseFloat(String(r['Total Cartons']  ?? '').replace(/[^\d.-]/g,'')) || 0,
          'Total Qty':      parseFloat(String(r['Total Qty']      ?? '').replace(/[^\d.-]/g,'')) || 0,
          _ts: isNaN(d) ? new Date(0) : d,
          _tsDisplay: isNaN(d) ? String(r['Timestamp']||'') : formatDate(d),
          _rowUid: `${String(r['Order Number']||'').trim()}::${String(r['Item ID']||'').trim()}::${iso}`
        };
      });
      buildDispatchChips();
      recomputeDispatch();
    })
    .catch(err => console.error(err));
}

function buildDispatchChips() {
  const wrap = document.getElementById('dispatchChips');
  if (!wrap) return;
  wrap.innerHTML = '';

  if (!STATE.dispatch.filters) STATE.dispatch.filters = { colour: null, search: '' };
  const current = STATE.dispatch.filters.colour;

  const makeActiveChip = (label, value) => {
    const isActive = current === value;
    const chip = makeChip(label, isActive, value, () => {
      STATE.dispatch.filters.colour = value;
      STATE.dispatch.pageIndex = 0;
      recomputeDispatch();
      buildDispatchChips();
    });
    if (isActive) chip.classList.add('active');
    return chip;
  };

  // ✅ "All" first
  wrap.appendChild(makeActiveChip('All', null));

  // ✅ normalized unique colours, sorted
  const colours = [...new Set(
    STATE.dispatch.raw.map(r => (r['Colour'] || '').toLowerCase().trim())
  )].filter(Boolean).sort();

  colours.forEach(c => wrap.appendChild(makeActiveChip(c, c)));
}

function recomputeDispatch() {
  let groups = groupByOrder(STATE.dispatch.raw);
  groups = applyDispatchFilters(groups);
  STATE.dispatch.filteredGroups = groups;
  STATE.dispatch.pages = paginateGroups(groups, STATE.dispatch.pageSize);
  renderDispatch();
}

function renderDispatch() {
  const body = document.getElementById('dispatchBody');
  body.innerHTML = '';
  const page = STATE.dispatch.pages[STATE.dispatch.pageIndex] || { rows: [] };

  if (!page.rows.length) {
    body.innerHTML='<tr><td colspan="9" class="muted">No rows</td></tr>';
  } else {
    page.rows.forEach(r => {
      const tr = document.createElement('tr');
      ['_tsDisplay','Order Number','Item ID','Colour','Qty Per Carton','Total Cartons','Total Qty','Status','User']
      .forEach(k => {
        const td = document.createElement('td');
        td.textContent = r[k] ?? '';
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });
  }

  updateDispatchPager();
  updateDispatchTotals();
}

function goDispatchPage(n) {
  const totalPages = STATE.dispatch.pages.length;
  STATE.dispatch.pageIndex = Math.min(Math.max(n, 0), totalPages - 1);
  renderDispatch();
}

function updateDispatchPager() {
  const pageNumEl = document.getElementById('dispatchPageNum');
  const prevBtn = document.getElementById('dispatchPrev');
  const nextBtn = document.getElementById('dispatchNext');
  const rowInfo = document.getElementById('dispatchRowInfo');

  const totalPages = STATE.dispatch.pages.length;
  const currentPage = STATE.dispatch.pageIndex + 1;

  if (pageNumEl) {
    if (totalPages === 0) pageNumEl.textContent = '0 / 0';
    else pageNumEl.textContent = `${currentPage} / ${totalPages}`;
  }

  if (prevBtn) prevBtn.disabled = (totalPages === 0 || currentPage <= 1);
  if (nextBtn) nextBtn.disabled = (totalPages === 0 || currentPage >= totalPages);

  const totalRows = STATE.dispatch.filteredGroups.reduce((sum,g) => sum + g.rows.length, 0);
  if (rowInfo) {
    if (totalRows === 0) rowInfo.textContent = '0–0 of 0';
    else {
      const start = (STATE.dispatch.pageIndex * STATE.dispatch.pageSize) + 1;
      const end = Math.min(start + STATE.dispatch.pageSize - 1, totalRows);
      rowInfo.textContent = `${start}–${end} of ${totalRows}`;
    }
  }
}

function updateDispatchTotals() {
  const countEl = document.getElementById('dispatchCount');
  const qtyEl = document.getElementById('dispatchQty');
  const cartonsEl = document.getElementById('dispatchCartons');

  const allRows = STATE.dispatch.filteredGroups.flatMap(g => g.rows);
  const totalOrders = STATE.dispatch.filteredGroups.length;
  const totalQty = allRows.reduce((sum, r) => sum + (parseFloat(r['Total Qty']) || 0), 0);
  const totalCartons = allRows.reduce((sum, r) => sum + (parseFloat(r['Total Cartons']) || 0), 0);

  if (countEl) countEl.textContent = totalOrders.toLocaleString('en-ZA');
  if (qtyEl) qtyEl.textContent = totalQty.toLocaleString('en-ZA');
  if (cartonsEl) cartonsEl.textContent = totalCartons.toLocaleString('en-ZA');
}

/**************
 * RECEIVING
 ***************/

// Map visible labels (if ever needed) to backend dataset keys
const DATASET_KEY_MAP = {
  'Receiving Stock': 'receiving',
  'Dispatched Orders': 'dispatch',
  'Stock': 'stock',
  'Recycled Stock': 'recycled'
};

function setupReceivingUI() {
  const searchEl = document.getElementById('receivingSearch');
  const prevBtn  = document.getElementById('receivingPrev');
  const nextBtn  = document.getElementById('receivingNext');
  const sizeSel  = document.getElementById('receivingPageSize');

  if (searchEl) {
    searchEl.addEventListener('input', debounce(() => {
      STATE.receiving.filters.search = searchEl.value.trim().toLowerCase();
      STATE.receiving.pageIndex = 0;
      recomputeReceiving();
    }, 120));
  }
  if (prevBtn) prevBtn.addEventListener('click', () => goReceivingPage(STATE.receiving.pageIndex - 1));
  if (nextBtn) nextBtn.addEventListener('click', () => goReceivingPage(STATE.receiving.pageIndex + 1));
  if (sizeSel) sizeSel.addEventListener('change', e => {
    const v = parseInt(e.target.value, 10);
    if (!Number.isNaN(v) && v > 0) {
      STATE.receiving.pageSize = v;
      STATE.receiving.pageIndex = 0;
      recomputeReceiving();
    }
  });
}

function loadReceiving(labelOverride) {
  // Pick dataset key — if a label is passed in, map it; else default to 'receiving'
  const datasetKey = DATASET_KEY_MAP[labelOverride] || 'receiving';

  fetch(`${API.baseUrl}?dataset=${encodeURIComponent(datasetKey)}&sheetName=${encodeURIComponent('Receiving Reports')}`)
    .then(res => res.json())
    .then(payload => {
      STATE.receiving.raw = (payload.rows || []).map(r => {
        const iso = r.timestampIso || r['Timestamp'] || '';
        const d = new Date(iso);
        return {
          ...r,
          'Qty Per Carton': parseFloat(String(r['Qty Per Carton'] ?? '').replace(/[^\d.-]/g,'')) || 0,
          'Total Cartons':  parseFloat(String(r['Total Cartons']  ?? '').replace(/[^\d.-]/g,'')) || 0,
          'Total Qty':      parseFloat(String(r['Total Qty']      ?? '').replace(/[^\d.-]/g,'')) || 0,
          _ts: isNaN(d) ? new Date(0) : d,
          _tsDisplay: isNaN(d) ? String(r['Timestamp']||'') : formatDate(d),
          _rowUid: `${String(r['Order Number']||'').trim()}::${String(r['Item ID']||'').trim()}::${iso}`
        };
      });
      buildReceivingChips();
      recomputeReceiving();
    })
    .catch(err => console.error(err));
}

function buildReceivingChips() {
  const wrap = document.getElementById('receivingChips');
  if (!wrap) return;
  wrap.innerHTML = '';

  if (!STATE.receiving.filters) STATE.receiving.filters = { colour: null, search: '' };
  const current = STATE.receiving.filters.colour;

  const makeActiveChip = (label, value) => {
    const isActive = current === value;
    const chip = makeChip(label, isActive, value, () => {
      STATE.receiving.filters.colour = value;
      STATE.receiving.pageIndex = 0;
      recomputeReceiving();
      buildReceivingChips();
    });
    if (isActive) chip.classList.add('active');
    return chip;
  };

  wrap.appendChild(makeActiveChip('All', null));

  const colours = [...new Set(
    STATE.receiving.raw.map(r => (r['Colour'] || '').toLowerCase().trim())
  )].filter(Boolean).sort();

  colours.forEach(c => wrap.appendChild(makeActiveChip(c, c)));
}

function applyReceivingFilters(groups) {
  const s = (STATE.receiving.filters.search || '').toLowerCase();
  const c = STATE.receiving.filters.colour;

  let out = groups;

  if (s) {
    out = out.map(g => ({
      key: g.key,
      rows: g.rows.filter(r =>
        String(r['Order Number']||'').toLowerCase().includes(s) ||
        String(r['Item ID']||'').toLowerCase().includes(s) ||
        String(r['Status']||'').toLowerCase().includes(s) ||
        String(r['Colour']||'').toLowerCase().includes(s)
      )
    })).filter(g => g.rows.length);
  }

  if (c !== null) {
    out = out.map(g => ({
      key: g.key,
      rows: g.rows.filter(r => (r['Colour']||'').toLowerCase().trim() === c)
    })).filter(g => g.rows.length);
  }

  out.sort((a,b) => {
    const at = a.rows.length ? new Date(a.rows[0].timestampIso || a.rows[0]['Timestamp']).getTime() : 0;
    const bt = b.rows.length ? new Date(b.rows[0].timestampIso || b.rows[0]['Timestamp']).getTime() : 0;
    return bt - at;
  });

  return out;
}

function recomputeReceiving() {
  let groups = groupByOrder(STATE.receiving.raw);
  groups = applyReceivingFilters(groups);
  STATE.receiving.filteredGroups = groups;
  STATE.receiving.pages = paginateGroups(groups, STATE.receiving.pageSize);
  renderReceiving();
}

function renderReceiving() {
  const body = document.getElementById('receivingBody');
  body.innerHTML = '';
  const page = STATE.receiving.pages[STATE.receiving.pageIndex] || { rows: [] };

  if (!page.rows.length) {
    body.innerHTML = '<tr><td colspan="9" class="muted">No rows</td></tr>';
  } else {
    page.rows.forEach(r => {
      const tr = document.createElement('tr');
      ['_tsDisplay','Order Number','Item ID','Colour','Qty Per Carton','Total Cartons','Total Qty','Status','User']
      .forEach(k => {
        const td = document.createElement('td');
        td.textContent = r[k] ?? '';
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });
  }

  updateReceivingPager();
  updateReceivingTotals();
}

function goReceivingPage(n) {
  const totalPages = STATE.receiving.pages.length;
  STATE.receiving.pageIndex = Math.min(Math.max(n, 0), Math.max(totalPages - 1, 0));
  renderReceiving();
}

function updateReceivingPager() {
  const pageNumEl = document.getElementById('receivingPageNum');
  const prevBtn = document.getElementById('receivingPrev');
  const nextBtn = document.getElementById('receivingNext');
  const rowInfo = document.getElementById('receivingRowInfo');

  const totalPages = STATE.receiving.pages.length;
  const currentPage = totalPages ? (STATE.receiving.pageIndex + 1) : 0;

  if (pageNumEl) pageNumEl.textContent = `${currentPage} / ${totalPages}`;

  if (prevBtn) prevBtn.disabled = (totalPages === 0 || currentPage <= 1);
  if (nextBtn) nextBtn.disabled = (totalPages === 0 || currentPage >= totalPages);

  const totalRows = STATE.receiving.filteredGroups.reduce((sum,g) => sum + g.rows.length, 0);
  if (rowInfo) {
    if (totalRows === 0) rowInfo.textContent = '0–0 of 0';
    else {
      const start = (STATE.receiving.pageIndex * STATE.receiving.pageSize) + 1;
      const end = Math.min(start + STATE.receiving.pageSize - 1, totalRows);
      rowInfo.textContent = `${start}–${end} of ${totalRows}`;
    }
  }
}

function updateReceivingTotals() {
  const countEl   = document.getElementById('receivingCount');
  const qtyEl     = document.getElementById('receivingQty');
  const cartonsEl = document.getElementById('receivingCartons');

  const orders = STATE.receiving.filteredGroups.length;
  const allRows = STATE.receiving.filteredGroups.flatMap(g => g.rows);

  const totalQty = allRows.reduce((sum, r) => sum + (parseFloat(r['Total Qty']) || 0), 0);
  const totalCartons = allRows.reduce((sum, r) => sum + (parseFloat(r['Total Cartons']) || 0), 0);

  if (countEl)   countEl.textContent   = orders.toLocaleString('en-ZA');
  if (qtyEl)     qtyEl.textContent     = totalQty.toLocaleString('en-ZA');
  if (cartonsEl) cartonsEl.textContent = totalCartons.toLocaleString('en-ZA');
}

    </script>
 <footer class="app-footer">
  <div class="footer-content">
    <span>Created by Thurston.   HangerFlow © 2025 </span>
    <span>Premierhangers (PTY) LTD </span>
  </div>
</footer>

  </body>
</html>





























