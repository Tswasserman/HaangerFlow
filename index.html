<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>HangerFlow</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #121821;
        --ink: #e8eef7;
        --muted: #9fb0c3;
        --accent: #3aa0ff;
        --accent-2: #7bd389;
        --danger: #ff6b6b;
        --border: #1e2633;
        --chip: #1a2431;
        --table-row: #0e141b;
        --table-row-alt: #121a23;
      }
      html, body { margin:0; padding:0; background:var(--bg); color:var(--ink); font:14px/1.4 Inter, Segoe UI, Roboto, Arial, sans-serif; }
      .app-header {
        display:flex; align-items:center; justify-content:space-between;
        padding:10px 16px; background:var(--panel); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10;
      }
      .left-nav { display:flex; gap:8px; }
      .nav-btn {
        background:#0f1620; color:var(--ink); border:1px solid var(--border);
        padding:8px 10px; border-radius:8px; cursor:pointer; transition:all .15s ease; font-weight:600;
      }
      .nav-btn.active, .nav-btn:hover { border-color:var(--accent); color:#fff; box-shadow:0 0 0 2px rgba(58,160,255,0.15) inset; }
      .brand { display:flex; align-items:center; gap:12px; }
      .brand-title { font-weight:800; letter-spacing:.5px; }
      .spacer { flex:1; }
      .logos { display:flex; align-items:center; gap:10px; }
      .logos img { height:28px; width:auto; filter:brightness(0.95) contrast(1.05); }

      .page { display:none; padding:16px; }
      .page.active { display:block; }

      .card {
        background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:12px;
      }

      /* Stock toolbar */
      .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
      .search { position:relative; flex:1; min-width:240px; }
      .search input {
        width:100%; background:#0f1620; color:var(--ink); border:1px solid var(--border);
        padding:10px 12px; border-radius:8px; outline:none;
      }
      .search input:focus { border-color:var(--accent); }
      .chip {
        background:var(--chip); border:1px solid var(--border); color:var(--muted);
        padding:8px 10px; border-radius:999px; cursor:pointer; user-select:none;
      }
      .chip.active { color:#fff; border-color:var(--accent-2); box-shadow:0 0 0 2px rgba(123,211,137,0.15) inset; }

      /* Table */
      .table-wrap { overflow:auto; max-height: calc(100vh - 180px); border:1px solid var(--border); border-radius:10px; }
      table { width:100%; border-collapse:separate; border-spacing:0; }
      thead th {
        position:sticky; top:0; background:#0d141c; color:#cfe3ff; text-align:left; padding:10px; font-size:12px; border-bottom:1px solid var(--border); cursor:pointer;
      }
      tbody td { padding:10px; border-bottom:1px solid var(--border); white-space:nowrap; }
      tbody tr:nth-child(odd) { background:var(--table-row); }
      tbody tr:nth-child(even) { background:var(--table-row-alt); }
      .kpi { display:flex; gap:12px; margin-bottom:10px; }
      .kpi .pill { background:#0f1620; border:1px solid var(--border); border-radius:8px; padding:8px 10px; color:var(--muted); }
      .pill strong { color:#fff; margin-left:6px; }

      .footerbar { display:flex; justify-content:space-between; align-items:center; padding:10px 6px; color:var(--muted); }
      .pager { display:flex; gap:8px; align-items:center; }
      .pager button { padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:#0f1620; color:var(--ink); cursor:pointer; }
      .sort-ind { margin-left:6px; color:var(--muted); font-size:12px; }
      .muted { color:var(--muted); }

      /* Page placeholders */
      .placeholder { padding:40px; text-align:center; color:var(--muted); border:1px dashed var(--border); border-radius:10px; }

      .upload-status { font-weight: bold; margin-top: 6px; color: #9fb0c3; }
      .last-upload { font-size: 0.9em; color: #9fb0c3; }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="left-nav" id="leftNav">
        <button class="nav-btn active" data-route="stock">Stock</button>
        <button class="nav-btn" data-route="dispatch">Dispatched Orders</button>
        <button class="nav-btn" data-route="receiving">Receiving Stock</button>
      </div>
      <div class="brand"><div class="brand-title">HangerFlow</div></div>
      <div class="spacer"></div>
      
    </header>

    <main>
      <!-- Stock Page -->
      <section id="page-stock" class="page active">
        <div class="card">
          <div class="toolbar">
            <div id="colourChips" class="chips"></div>
            <div class="search">
              <input type="text" id="searchInput" placeholder="Search item, colour or PH code...">
            </div>
          </div>

          <div id="uploadStatus" class="upload-status">Waiting…</div>
          <div id="lastUpload" class="last-upload">Last update: –</div>

          <div class="kpi">
            <div class="pill">Items<strong id="kpiItems">0</strong></div>
            <div class="pill">Total QTY<strong id="kpiTotalQty">0</strong></div>
            <div class="pill">Total Cartons<strong id="kpiCartons">0</strong></div>
          </div>

          <div class="table-wrap">
            <table id="stockTable">
              <thead><tr id="stockHeadRow"></tr></thead>
              <tbody id="stockBody"></tbody>
            </table>
          </div>

          <div class="footerbar">
            <div class="muted" id="rowInfo">0–0 of 0</div>
            <div class="pager">
              <button id="prevBtn">Prev</button>
              <span class="muted" id="pageNum">1</span>
              <button id="nextBtn">Next</button>
              <select id="pageSize" title="Rows per page">
                <option>25</option><option selected>50</option><option>100</option><option>200</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Dispatch Page -->
      <section id="page-dispatch" class="page">
        <div class="card">
          <div class="toolbar">
            <div id="dispatchChips" class="chips"></div>
            <div class="search">
              <input type="text" id="dispatchSearch" placeholder="Search Order Number, Colour, or Status…">
            </div>
          </div>

          <div class="kpi">
            <div class="pill">Orders<strong id="dispatchCount">0</strong></div>
            <div class="pill">Total Qty<strong id="dispatchQty">0</strong></div>
            <div class="pill">Total Cartons<strong id="dispatchCartons">0</strong></div>
          </div>

          <div class="table-wrap">
            <table id="dispatchTable">
              <thead><tr id="dispatchHeadRow"></tr></thead>
              <tbody id="dispatchBody"></tbody>
            </table>
          </div>

          <div class="footerbar">
            <div class="muted" id="dispatchRowInfo">0–0 of 0</div>
            <div class="pager">
              <button id="dispatchPrev">Prev</button>
              <span class="muted" id="dispatchPageNum">1</span>
              <button id="dispatchNext">Next</button>
              <select id="dispatchPageSize">
                <option>25</option><option selected>50</option><option>100</option><option>200</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Receiving Page -->
      <section id="page-receiving" class="page">
        <div class="placeholder">Receiving page — coming soon.</div>
      </section>
    </main>

    <script>
   // --- Utilities & UI helpers (load these first) ---
if (!window.debounce) {
  window.debounce = function (fn, delay) {
    let timer;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  };
}

if (!window.setUploadStatus) {
  window.setUploadStatus = function (text) {
    const el = document.getElementById('uploadStatus');
    if (el) el.textContent = text;
  };
}

if (!window.updateLastUpload) {
  window.updateLastUpload = function (d) {
    const el = document.getElementById('lastUpload');
    if (!el) return;
    const ts = d instanceof Date && !isNaN(d) ? d.toLocaleString('en-ZA', {
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: false
    }) : '–';
    el.textContent = `Last update: ${ts}`;
  };
}

if (!window.formatDate) {
  window.formatDate = function (d) {
    if (!(d instanceof Date) || isNaN(d)) return '';
    return d.toLocaleString('en-ZA', {
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: false
    });
  };
}


     /***************
 * CONFIG
 ***************/
const API = {
  baseUrl: 'https://script.google.com/macros/s/AKfycbzCF7yUZiprbPZtqCIRj6cy5iXaFYxs2iR22fArEFkIRG8Xq38DHcpzIz232OiKOPrdwg/exec',
  resource: 'stock',
  useJsonpFallback: true
};

/***************
 * GLOBAL STATE
 ***************/
const STATE = {
  stock: {
    data: [], filtered: [],
    sortKey: 'Colour', sortDir: 'asc',
    page: 1, pageSize: 50, colourFilter: null,
    columns: ['timestamp','Colour','QTY Per Carton','Total Cartons','Total QTY','PH Code']
  },
  dispatch: {
    raw: [], groups: [], filteredGroups: [], pages: [],
    pageIndex: 0, pageSize: 50, filters: { search: '', colour: null }
  },
  receiving: {
    data: [], page: 1, pageSize: 50
  }
};

/***************
 * INIT
 ***************/
document.addEventListener('DOMContentLoaded', () => {
  setupNav();
  setupStockUI();
  setupDispatchUI();
  loadStock();
  switchPage('stock');
});

/***************
 * NAVIGATION
 ***************/
function setupNav() {
  document.getElementById('leftNav').addEventListener('click', (e) => {
    const btn = e.target.closest('.nav-btn');
    if (!btn) return;
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    switchPage(btn.dataset.route);
  });
}
function switchPage(route) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${route}`)?.classList.add('active');
  if (route === 'stock') loadStock();
  if (route === 'dispatch') loadDispatch();
  if (route === 'receiving') loadReceiving();
}

/***************
 * STOCK
 ***************/
function setupStockUI() {
  const head = document.getElementById('stockHeadRow');
  head.innerHTML = '';
  STATE.stock.columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    th.addEventListener('click', () => toggleSort(col));
    head.appendChild(th);
  });
  document.getElementById('searchInput').addEventListener('input', debounce(() => {
    STATE.stock.page = 1; applyStockFilters(); renderStock();
  }, 120));
}
function loadStock() {
  setUploadStatus('Loading…');
  fetch(`${API.baseUrl}?dataset=stock`)
    .then(res => res.json())
    .then(payload => {
      STATE.stock.data = (payload.rows||[]).map(r => ({
        timestamp: r.timestampIso || r.timestamp || '',
        Colour: r['Colour'],
        'QTY Per Carton': r['QTY Per Carton'],
        'Total Cartons': r['Total Cartons'],
        'Total QTY': r['Total QTY'],
        'PH Code': r['PH Code'],
        _searchKey: `${r['Colour']||''} ${r['PH Code']||''}`.toLowerCase()
      }));
      buildStockChips();
      applyStockFilters();
      renderStock();
      updateLastUpload(new Date());
      setUploadStatus('Loaded');
    }).catch(err => { console.error(err); setUploadStatus('Failed'); });
}
function buildStockChips() {
  const wrap = document.getElementById('colourChips');
  wrap.innerHTML = '';
  const colours = [...new Set(STATE.stock.data.map(r => (r.Colour||'').toLowerCase().trim()))].filter(Boolean).sort();
  const allChip = makeChip('All', STATE.stock.colourFilter === null, null, () => { STATE.stock.colourFilter = null; applyStockFilters(); renderStock(); });
  wrap.appendChild(allChip);
  colours.forEach(c => {
    wrap.appendChild(makeChip(c, STATE.stock.colourFilter === c, c, () => { STATE.stock.colourFilter = c; applyStockFilters(); renderStock(); }));
  });
}
function applyStockFilters() {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const cf = STATE.stock.colourFilter;
  let out = STATE.stock.data;
  if (q) out = out.filter(r => r._searchKey.includes(q));
  if (cf) out = out.filter(r => (r.Colour||'').toLowerCase().trim() === cf);
  const dir = STATE.stock.sortDir === 'asc' ? 1 : -1;
  out.sort((a, b) => String(a[STATE.stock.sortKey]??'').localeCompare(String(b[STATE.stock.sortKey]??''), undefined, { numeric: true })*dir);
  STATE.stock.filtered = out;
}
function renderStock() {
  const body = document.getElementById('stockBody');
  body.innerHTML = '';
  const ps = STATE.stock.pageSize;
  const start = (STATE.stock.page-1)*ps;
  const end = start + ps;
  STATE.stock.filtered.slice(start, end).forEach(r => {
    const tr = document.createElement('tr');
    STATE.stock.columns.forEach(col => {
      const td = document.createElement('td');
      td.textContent = col==='timestamp' && r[col] ? new Date(r[col]).toLocaleString() : (r[col]??'');
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}
function toggleSort(col) {
  STATE.stock.sortKey = col;
  STATE.stock.sortDir = STATE.stock.sortDir === 'asc' ? 'desc' : 'asc';
  applyStockFilters(); renderStock();
}

/***************
 * DISPATCH
 ***************/
function setupDispatchUI() {
  document.getElementById('dispatchSearch').addEventListener('input', debounce(() => {
    STATE.dispatch.filters.search = document.getElementById('dispatchSearch').value.trim().toLowerCase();
    recomputeDispatch();
  }, 120));
}
function loadDispatch() {
  fetch(`${API.baseUrl}?dataset=dispatch`)
    .then(res => res.json())
    .then(payload => {
      STATE.dispatch.raw = (payload.rows||[]).map(r => {
        const iso = r.timestampIso || r['Timestamp'] || '';
        const d = new Date(iso);
        return {
          ...r,
          _ts: isNaN(d) ? new Date(0) : d,
          _tsDisplay: isNaN(d) ? String(r['Timestamp']||'') : formatDate(d),
          _rowUid: `${String(r['Order Number']||'').trim()}::${String(r['Item ID']||'').trim()}::${iso}`
        };
      });
      buildDispatchChips();
      recomputeDispatch();
    }).catch(err => console.error(err));
}
function buildDispatchChips() {
  const wrap = document.getElementById('dispatchChips');
  wrap.innerHTML = '';
  const colours = [...new Set(STATE.dispatch.raw.map(r => r['Colour']).filter(Boolean))].sort();
  wrap.appendChild(makeChip('All', !STATE.dispatch.filters.colour, null, () => { STATE.dispatch.filters.colour=null; recomputeDispatch(); }));
  colours.forEach(c => {
    wrap.appendChild(makeChip(c, STATE.dispatch.filters.colour===c, c, () => { STATE.dispatch.filters.colour=c; recomputeDispatch(); }));
  });
}
function recomputeDispatch() {
  let groups = groupByOrder(STATE.dispatch.raw);
  groups = applyDispatchFilters(groups);
  STATE.dispatch.filteredGroups = groups;
  STATE.dispatch.pages = paginateGroups(groups, STATE.dispatch.pageSize);
  renderDispatch();
}
function renderDispatch() {
  const body = document.getElementById('dispatchBody');
  body.innerHTML = '';
  const page = STATE.dispatch.pages[STATE.dispatch.pageIndex] || { rows: [] };
  if (!page.rows.length) { body.innerHTML='<tr><td colspan="9" class="muted">No rows</td></tr>'; return; }
  page.rows.forEach(r => {
    const tr = document.createElement('tr');
    ['_tsDisplay','Order Number','Item ID','Colour','Qty Per Carton','Total Cartons','Total Qty','Status','User']
    .forEach(k => {
      const td = document.createElement('td');
      td.textContent = r[k] ?? '';
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

/***************
 * RECEIVING
 ***************/
function loadReceiving() {
  fetch(`${API.baseUrl}?dataset=receiving`)
    .then(res => res.json())
    .then(payload => {
      STATE.receiving.data = payload.rows || [];
      console.log('Receiving rows', STATE.receiving.data);
      // TODO: render table like stock
    })
    .catch(err => console.error(err));
}

    </script>
  </body>

</html>

